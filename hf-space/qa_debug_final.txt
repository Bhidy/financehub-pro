============================= test session starts ==============================
platform darwin -- Python 3.13.3, pytest-9.0.2, pluggy-1.6.0
rootdir: /Users/home/Documents/Info Site/mubasher-deep-extract/hf-space
plugins: anyio-4.12.0, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 1 item

testsprite_tests/TC003_ai_analyst_chatbot_financial_insights_relevance.py F [100%]

=================================== FAILURES ===================================
__________________________ test_ai_chatbot_production __________________________

    def test_ai_chatbot_production():
        device_fingerprint = f"qa-test-{uuid.uuid4().hex[:8]}"
        session_id = str(uuid.uuid4())
    
        headers = {
            "Content-Type": "application/json",
            "X-Device-Fingerprint": device_fingerprint
        }
    
        def chat(msg, hist=[]):
            payload = {
                "message": msg,
                "session_id": session_id,
                "history": hist
            }
            resp = requests.post(f"{BASE_API_URL}/api/v1/ai/chat", json=payload, headers=headers, timeout=TIMEOUT)
            resp.raise_for_status()
            return resp.json()
    
        print(f"ğŸš€ [QA] Starting Expert Production Test against: {BASE_API_URL}")
    
        # Step 1: Ticker Resolution & Symbol Mapping (CIB -> COMI)
        print("Testing Turn 1: Symbol Resolution (CIB)...")
        resp1 = chat("What is the price of CIB?")
        print(f"DEBUG Turn 1 Response: {resp1}")
        assert resp1["meta"]["intent"] == "STOCK_PRICE", f"Wrong intent: {resp1['meta']['intent']}"
        assert any(c["type"] == "stock_header" for c in resp1["cards"]), "Missing stock_header card"
        print("âœ… Turn 1 Passed.")
    
        # Step 2: Multi-turn Context / Stats
        print("Testing Turn 2: Valuation Stats (COMI)...")
        resp2 = chat("PE ratio COMI")
        print(f"DEBUG Turn 2 Response: {resp2}")
        assert resp2["meta"]["intent"] == "STOCK_STAT", f"Wrong intent: {resp2['meta']['intent']}"
        assert any(c["type"] in ["stats", "error"] and "valuation" in c.get("data", {}) for c in resp2["cards"]), "Missing stats/valuation card"
        print("âœ… Turn 2 Passed.")
    
        # Step 3: Technical Indicators & Ratios
        print("Testing Turn 3: Technical Indicators (COMI)...")
        resp3 = chat("What is the RSI and MACD for COMI?")
        print(f"DEBUG Turn 3 Response: {resp3}")
        # Technical Indicators should return technicals card or mention RSI
>       assert "rsi" in resp3["message_text"].lower() or any(c["type"] == "technicals" for c in resp3["cards"])
E       assert ('rsi' in "i'm having trouble processing your request. please try again." or False)
E        +  where "i'm having trouble processing your request. please try again." = <built-in method lower of str object at 0x106f4ad40>()
E        +    where <built-in method lower of str object at 0x106f4ad40> = "I'm having trouble processing your request. Please try again.".lower
E        +  and   False = any(<generator object test_ai_chatbot_production.<locals>.<genexpr> at 0x106fdcba0>)

testsprite_tests/TC003_ai_analyst_chatbot_financial_insights_relevance.py:49: AssertionError
----------------------------- Captured stdout call -----------------------------
ğŸš€ [QA] Starting Expert Production Test against: https://bhidy-financehub-api.hf.space
Testing Turn 1: Symbol Resolution (CIB)...
DEBUG Turn 1 Response: {'message_text': "ğŸ“Š **Commercial International Bank Egypt (CIB) S.A.E.** (COMI)\n\nğŸ’° **Price:** EGP 104.30 â†‘ (+1.25%) ğŸ“ˆ\n\nğŸ“ˆ **Today's Range:** 103.40 - 105.58\nğŸ”“ **Open:** 103.01 | **Prev Close:** 104.30\nğŸ“¦ **Volume:** 3.73M\n\nğŸ¢ **Sector:** Commercial Banks", 'message_text_ar': None, 'language': 'en', 'cards': [{'type': 'stock_header', 'title': None, 'data': {'symbol': 'COMI', 'name': 'Commercial International Bank Egypt (CIB) S.A.E.', 'market_code': 'EGX', 'currency': 'EGP', 'sector': 'Commercial Banks', 'as_of': '2026-01-11T14:15:37.108607+00:00'}}, {'type': 'snapshot', 'title': None, 'data': {'last_price': 104.3, 'change': 0.0, 'change_percent': 1.252, 'volume': 3729539, 'open': 103.01, 'high': 105.58, 'low': 103.4, 'prev_close': 104.3, 'currency': 'EGP', 'trend_emoji': 'ğŸ“ˆ'}}, {'type': 'stats', 'title': 'Valuation & Stats', 'data': {'pe_ratio': 5.17, 'dividend_yield': 0.0226, 'market_cap': 352320000000, 'market_cap_formatted': '352.32B'}}], 'chart': None, 'actions': [{'label': 'ğŸ“Š View Chart', 'label_ar': 'ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø±Øª', 'action_type': 'query', 'payload': 'Chart COMI'}, {'label': 'ğŸ’° Financials', 'label_ar': 'ğŸ’° Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©', 'action_type': 'query', 'payload': 'COMI financials'}, {'label': 'ğŸ’µ Dividends', 'label_ar': 'ğŸ’µ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª', 'action_type': 'query', 'payload': 'COMI dividends'}, {'label': 'ğŸ‘¥ Shareholders', 'label_ar': 'ğŸ‘¥ Ø§Ù„Ù…Ø³Ø§Ù‡Ù…ÙŠÙ†', 'action_type': 'query', 'payload': 'COMI shareholders'}, {'label': 'âš™ï¸ Technicals', 'label_ar': 'âš™ï¸ Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠ Ø§Ù„ÙÙ†ÙŠ', 'action_type': 'query', 'payload': 'COMI technicals'}], 'disclaimer': None, 'meta': {'intent': 'STOCK_PRICE', 'confidence': 0.57, 'entities': {'term': 'the price of cib', 'symbol': 'COMI', 'market_code': 'EGX'}, 'latency_ms': 1707, 'cached': False, 'as_of': '2026-01-11T23:27:07.519876', 'backend_version': '2.6'}}
âœ… Turn 1 Passed.
Testing Turn 2: Valuation Stats (COMI)...
DEBUG Turn 2 Response: {'message_text': 'ğŸ“Š **Comprehensive Statistics for Commercial International Bank Egypt (CIB) S.A.E.** (COMI)\n\nğŸ’° **Valuation Ratios:**\nâ€¢ P/E Ratio: 5.17\nâ€¢ P/B Ratio: 1.69\nâ€¢ P/S Ratio: 2.84\n\nğŸ“ˆ **Financial Efficiency:**\nâ€¢ ROE: 43.30%\nâ€¢ ROA: 6.06%\nâ€¢ ROIC: N/A\n\nğŸ’µ **Margins:**\nâ€¢ Gross Margin: N/A\nâ€¢ Operating Margin: 82.10%\nâ€¢ Profit Margin: 60.44%\n\nâš–ï¸ **Financial Health:**\nâ€¢ Current Ratio: N/A\nâ€¢ Debt/Equity: N/A\n\nğŸ“‰ **Technical Indicators:**\nâ€¢ Beta (5Y): 0.42\nâ€¢ RSI (14): 54.82', 'message_text_ar': None, 'language': 'en', 'cards': [{'type': 'stock_header', 'title': None, 'data': {'symbol': 'COMI', 'name': 'Commercial International Bank Egypt (CIB) S.A.E.', 'market_code': 'EGX', 'currency': 'EGP'}}, {'type': 'error', 'title': 'Full Statistics', 'data': {'valuation': {'pe_ratio': 5.17, 'pb_ratio': 1.69, 'ps_ratio': 2.84, 'forward_pe': 5.41, 'peg_ratio': None}, 'efficiency': {'roe': 0.433, 'roa': 0.0606, 'roic': None}, 'margins': {'gross_margin': None, 'operating_margin': 0.821, 'profit_margin': 0.6044}, 'financial_health': {'current_ratio': None, 'quick_ratio': None, 'debt_equity': None}, 'technical': {'beta_5y': 0.42, 'rsi_14': 54.82, 'ma_50d': 101.04, 'ma_200d': 86.08}}}], 'chart': None, 'actions': [{'label': 'ğŸ“ˆ Chart', 'label_ar': 'ğŸ“ˆ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ', 'action_type': 'query', 'payload': 'Chart COMI'}, {'label': 'ğŸ’° Dividends', 'label_ar': 'ğŸ’° Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª', 'action_type': 'query', 'payload': 'COMI dividends'}, {'label': 'ğŸ“‹ Financials', 'label_ar': 'ğŸ“‹ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©', 'action_type': 'query', 'payload': 'COMI financials'}], 'disclaimer': 'Data is for informational purposes only. This is not investment advice.', 'meta': {'intent': 'STOCK_STAT', 'confidence': 0.5, 'entities': {'symbol': 'COMI', 'market_code': 'EGX'}, 'latency_ms': 1709, 'cached': False, 'as_of': '2026-01-11T23:27:11.207294', 'backend_version': '2.6'}}
âœ… Turn 2 Passed.
Testing Turn 3: Technical Indicators (COMI)...
DEBUG Turn 3 Response: {'message_text': "I'm having trouble processing your request. Please try again.", 'message_text_ar': 'Ø£ÙˆØ§Ø¬Ù‡ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'language': 'en', 'cards': [], 'chart': None, 'actions': [], 'disclaimer': None, 'meta': {'intent': 'ERROR', 'confidence': 0, 'entities': {}, 'latency_ms': 0, 'error': 'column "revenue_growth" does not exist'}}
=========================== short test summary info ============================
FAILED testsprite_tests/TC003_ai_analyst_chatbot_financial_insights_relevance.py::test_ai_chatbot_production
============================== 1 failed in 14.70s ==============================
