name: Enterprise Data Update System

on:
  schedule:
    # PRICES: Every 5 min during market hours (6-13 UTC = 9-16 Saudi/Cairo)
    - cron: '*/5 6-13 * * 0-4'
    
    # DAILY SYNC: 6 PM Saudi (15:00 UTC)
    - cron: '0 15 * * 0-4'
    
    # EGYPT FUNDS: 7 PM Saudi (16:00 UTC)
    - cron: '0 16 * * 0-4'
    
    # AI INGESTION: 8 PM Saudi (17:00 UTC)
    - cron: '0 17 * * 0-4'
    
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Job to Run'
        required: true
        default: 'prices'
        type: choice
        options:
          - prices
          - daily
          - egypt-funds
          - ingestion
          - backfill

# CRITICAL: This workflow must be pushed to GitHub to take effect!
env:
  FINHUB_API_BASE: https://starta.46-224-223-172.sslip.io/api/v1/admin

jobs:
  # ============================================================
  # UNIFIED WATCHDOG - Single Job, All Updates via Backend API
  # ============================================================
  watchdog:
    name: üêï Enterprise Watchdog
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: üöÄ Start Watchdog
        run: echo "Enterprise Watchdog starting at $(date)"

      - name: Set up jq
        run: sudo apt-get install -y jq

      # ============================================================
      # JOB 1: PRICE REFRESH (Every 5 min during market hours)
      # ============================================================
      - name: üìà Price Refresh
        if: |
          (github.event_name == 'schedule' && contains(github.event.schedule, '*/5')) ||
          (github.event.inputs.job_type == 'prices')
        run: |
          ENDPOINT="/refresh/prices"
          echo "üöÄ Triggering Price Refresh..."
          RESPONSE=$(curl -s -X POST "${{ env.FINHUB_API_BASE }}$ENDPOINT" -H "Content-Type: application/json" --max-time 30)
          echo "Trigger Response: $RESPONSE"

          # Start Polling
          echo "‚è≥ Polling for completion..."
          START_TIME=$(date +%s)
          while true; do
            STATUS_JSON=$(curl -s "${{ env.FINHUB_API_BASE }}/refresh/status")
            IS_RUNNING=$(echo "$STATUS_JSON" | jq -r '.is_running')
            LAST_STATUS=$(echo "$STATUS_JSON" | jq -r '.last_status')
            UPDATED=$(echo "$STATUS_JSON" | jq -r '.tickers_updated')
            
            echo "Status: $LAST_STATUS | Running: $IS_RUNNING | Updated: $UPDATED"
            
            if [ "$IS_RUNNING" == "false" ]; then
              echo "‚úÖ Job Completed!"
              break
            fi
            sleep 5
            if [ $(($(date +%s) - START_TIME)) -gt 300 ]; then echo "‚ùå Timeout"; exit 1; fi
          done

      # ============================================================
      # JOB 2: DAILY SYNC (6 PM Saudi - OHLC + Financials)
      # ============================================================
      - name: üìä Daily EOD Sync
        if: |
          (github.event_name == 'schedule' && contains(github.event.schedule, '0 15')) ||
          (github.event.inputs.job_type == 'daily')
        run: |
          ENDPOINT="/refresh/daily"
          echo "üöÄ Triggering Daily Sync..."
          curl -s -X POST "${{ env.FINHUB_API_BASE }}$ENDPOINT" -H "Content-Type: application/json" --max-time 30
          
          # Start Polling
          echo "‚è≥ Polling for completion..."
          START_TIME=$(date +%s)
          while true; do
            STATUS_JSON=$(curl -s "${{ env.FINHUB_API_BASE }}/refresh/status")
            IS_RUNNING=$(echo "$STATUS_JSON" | jq -r '.is_running')
            LAST_STATUS=$(echo "$STATUS_JSON" | jq -r '.last_status')
            
            echo "Status: $LAST_STATUS"
            
            if [ "$IS_RUNNING" == "false" ]; then
              echo "‚úÖ Daily Sync Completed!"
              break
            fi
            sleep 10
            if [ $(($(date +%s) - START_TIME)) -gt 3000 ]; then echo "‚ùå Timeout"; exit 1; fi
          done

      # ============================================================
      # JOB 3: EGYPT FUNDS (7 PM Saudi)
      # ============================================================
      - name: üí∞ Egypt Funds Sync
        if: |
          (github.event_name == 'schedule' && contains(github.event.schedule, '0 16')) ||
          (github.event.inputs.job_type == 'egypt-funds')
        run: |
          ENDPOINT="/refresh/egypt-funds"
          echo "üöÄ Triggering Egypt Funds..."
          curl -s -X POST "${{ env.FINHUB_API_BASE }}$ENDPOINT" -H "Content-Type: application/json" --max-time 30
          
          # Poll
          START_TIME=$(date +%s)
          while true; do
            STATUS_JSON=$(curl -s "${{ env.FINHUB_API_BASE }}/refresh/status")
            IS_RUNNING=$(echo "$STATUS_JSON" | jq -r '.is_running')
            echo "Running: $IS_RUNNING"
            if [ "$IS_RUNNING" == "false" ]; then echo "‚úÖ Done"; break; fi
            sleep 10
            if [ $(($(date +%s) - START_TIME)) -gt 600 ]; then echo "‚ùå Timeout"; exit 1; fi
          done

      # ============================================================
      # JOB 4: AI INGESTION (8 PM Saudi)
      # ============================================================
      - name: ü§ñ AI Knowledge Ingestion
        if: |
          (github.event_name == 'schedule' && contains(github.event.schedule, '0 17')) ||
          (github.event.inputs.job_type == 'ingestion')
        run: |
          ENDPOINT="/refresh/ingestion"
          echo "üöÄ Triggering AI Ingestion..."
          curl -s -X POST "${{ env.FINHUB_API_BASE }}$ENDPOINT" -H "Content-Type: application/json" --max-time 30
          
          # Poll - This is the long one!
          echo "‚è≥ Polling for completion (May take 30 mins)..."
          START_TIME=$(date +%s)
          while true; do
            STATUS_JSON=$(curl -s "${{ env.FINHUB_API_BASE }}/refresh/status")
            IS_RUNNING=$(echo "$STATUS_JSON" | jq -r '.is_running')
            LAST_STATUS=$(echo "$STATUS_JSON" | jq -r '.last_status')
            
            # Print nice status line
            echo "Status: $LAST_STATUS"
            
            if [ "$IS_RUNNING" == "false" ]; then
              echo "‚úÖ AI Ingestion Completed!"
              break
            fi
            sleep 10
            if [ $(($(date +%s) - START_TIME)) -gt 3500 ]; then echo "‚ùå Timeout"; exit 1; fi
          done

      # ============================================================
      # JOB 5: BACKFILL (Manual Only)
      # ============================================================
      - name: üìö Historical Backfill
        if: github.event.inputs.job_type == 'backfill'
        run: |
          echo "Triggering Backfill..."
          curl -s -X POST "${{ env.FINHUB_API_BASE }}/refresh/backfill" -H "Content-Type: application/json"
          echo "Polling..."
          START_TIME=$(date +%s)
          while true; do
            STATUS_JSON=$(curl -s "${{ env.FINHUB_API_BASE }}/refresh/status")
            IS_RUNNING=$(echo "$STATUS_JSON" | jq -r '.is_running')
            LAST_STATUS=$(echo "$STATUS_JSON" | jq -r '.last_status')
            echo "$LAST_STATUS"
            if [ "$IS_RUNNING" == "false" ]; then echo "‚úÖ Done"; break; fi
            sleep 10
            if [ $(($(date +%s) - START_TIME)) -gt 3500 ]; then echo "‚ùå Timeout"; exit 1; fi
          done

      # ============================================================
      # ALERTING SYSTEM
      # ============================================================
      - name: ‚úÖ Discord Success Alert
        if: success()
        run: |
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"content": "‚úÖ **FinanceHub Watchdog**: Auto-update cycle completed successfully at '"$(date)"'"}'
          
      - name: üö® Discord Failure Alert
        if: failure()
        run: |
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"content": "üö® **CRITICAL**: FinanceHub Watchdog FAILED!\n**Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
