name: Intraday Stock Price Updates

# Runs every 5 minutes during Saudi market hours (10 AM - 3 PM Saudi = 7 AM - 12 PM UTC)
# Trading days: Sunday-Thursday

on:
  schedule:
    # Every 5 minutes from 7:00 AM to 11:55 AM UTC (10 AM - 2:55 PM Saudi)
    # Sunday = 0, Thursday = 4
    - cron: '*/5 7-11 * * 0-4'
    
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even outside market hours'
        required: false
        default: 'false'
        type: boolean

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  update-live-prices:
    name: üìà Live Price Update
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Check Market Hours
        id: market_check
        run: |
          # Get current hour in Saudi time (UTC+3)
          SAUDI_HOUR=$(TZ='Asia/Riyadh' date +%H)
          SAUDI_DAY=$(TZ='Asia/Riyadh' date +%u)  # 1=Monday, 7=Sunday
          
          echo "Saudi Time: $(TZ='Asia/Riyadh' date)"
          echo "Saudi Hour: $SAUDI_HOUR"
          echo "Saudi Day: $SAUDI_DAY (7=Sunday, 4=Thursday)"
          
          # Market open: 10:00 - 15:00 Saudi, Sun-Thu
          # Day 7=Sunday, 1=Monday, 4=Thursday
          if [[ "$SAUDI_DAY" -ge 1 && "$SAUDI_DAY" -le 4 ]] || [[ "$SAUDI_DAY" -eq 7 ]]; then
            if [[ "$SAUDI_HOUR" -ge 10 && "$SAUDI_HOUR" -lt 15 ]]; then
              echo "market_open=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Market is OPEN"
            else
              echo "market_open=false" >> $GITHUB_OUTPUT
              echo "‚è∞ Market is CLOSED (outside hours)"
            fi
          else
            echo "market_open=false" >> $GITHUB_OUTPUT
            echo "üìÖ Market is CLOSED (weekend - Friday/Saturday)"
          fi
          
      - name: Checkout
        if: steps.market_check.outputs.market_open == 'true' || github.event.inputs.force_update == 'true'
        uses: actions/checkout@v4
        
      - name: Setup Python
        if: steps.market_check.outputs.market_open == 'true' || github.event.inputs.force_update == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        if: steps.market_check.outputs.market_open == 'true' || github.event.inputs.force_update == 'true'
        run: pip install asyncpg yfinance
        
      - name: Update Live Stock Prices
        if: steps.market_check.outputs.market_open == 'true' || github.event.inputs.force_update == 'true'
        run: python scripts/fetch_yahoo_data.py
        
      - name: Log Update Time
        if: steps.market_check.outputs.market_open == 'true' || github.event.inputs.force_update == 'true'
        run: |
          echo "‚úÖ Prices updated at $(date -u)"
          echo "Next update in ~5 minutes"

  # Alert on failure
  notify-failure:
    name: üö® Failure Alert
    runs-on: ubuntu-latest
    needs: update-live-prices
    if: failure()
    
    steps:
      - name: Send Failure Email
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üö® FinanceHub: Intraday Price Update FAILED"
          to: "${{ secrets.NOTIFICATION_EMAIL }},m.mostafa@mubasher.net"
          from: FinanceHub Pro <${{ secrets.NOTIFICATION_EMAIL }}>
          body: |
            ‚ö†Ô∏è INTRADAY PRICE UPDATE FAILED
            
            Time: ${{ github.event.head_commit.timestamp }}
            Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            This affects live stock prices on the website.
            Please investigate immediately.
