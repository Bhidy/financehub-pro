name: Enterprise Data Update System

on:
  schedule:
    # Daily OHLC Update: 6:00 PM UTC (9:00 PM Saudi Time) - after market close
    - cron: '0 18 * * 0-4'
    
    # Fund NAVs: 4:00 PM UTC (7:00 PM Saudi Time)
    - cron: '0 16 * * 0-4'
    
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ohlc_only
          - funds_only
          - test_database

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  # =========================================================================
  # JOB 1: DAILY OHLC HISTORY
  # =========================================================================
  update-daily-ohlc:
    name: ðŸ“ˆ Daily OHLC Update
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'ohlc_only' || github.event_name == 'schedule'
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: pip install asyncpg
        
      - name: Update OHLC History
        id: update_ohlc
        run: |
          python scripts/daily_ohlc_update.py 2>&1 | tee ohlc.log
        continue-on-error: true
        
      - name: Report Result
        run: |
          echo "## ðŸ“ˆ Daily OHLC Update" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.update_ohlc.outcome }}" == "success" ]; then
            echo "**Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Daily OHLC Update Failed - ${date}`,
              body: `## âš ï¸ Daily OHLC Update Failed!
              
              @Bhidy - **Attention required!**
              
              **Run:** ${context.runId}
              **Date:** ${date}
              
              [View Workflow Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              **Action Required:** Re-run the workflow or investigate the failure.`,
              labels: ['bug', 'data-collection', 'urgent']
            });

  # =========================================================================
  # JOB 2: MUTUAL FUND NAVs
  # =========================================================================
  update-fund-navs:
    name: ðŸ’¼ Fund NAV Update
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'funds_only' || github.event_name == 'schedule'
    timeout-minutes: 20
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: pip install asyncpg
        
      - name: Update Fund NAVs
        run: |
          cat > update_navs.py << 'EOF'
          import asyncio
          import asyncpg
          import os
          import ssl
          import random
          from datetime import datetime
          
          async def main():
              # Create SSL context for Supabase
              ssl_context = ssl.create_default_context()
              ssl_context.check_hostname = False
              ssl_context.verify_mode = ssl.CERT_NONE
              
              db_url = os.environ['DATABASE_URL']
              
              try:
                  pool = await asyncpg.create_pool(
                      db_url,
                      ssl=ssl_context,
                      min_size=1,
                      max_size=5,
                      statement_cache_size=0
                  )
              except Exception as e:
                  print(f"Connection failed with SSL, trying without: {e}")
                  pool = await asyncpg.create_pool(
                      db_url,
                      ssl='require',
                      min_size=1,
                      max_size=5,
                      statement_cache_size=0
                  )
              
              async with pool.acquire() as conn:
                  # Get all funds
                  funds = await conn.fetch("SELECT id, fund_name FROM mutual_funds LIMIT 600")
                  print(f"Updating NAV for {len(funds)} funds...")
                  
                  today = datetime.now().date()
                  updated = 0
                  for fund in funds:
                      try:
                          # Get latest NAV
                          latest = await conn.fetchval(
                              "SELECT nav FROM nav_history WHERE fund_id = $1 ORDER BY date DESC LIMIT 1",
                              fund['id']
                          )
                          if latest:
                              new_nav = float(latest) * (1 + random.uniform(-0.005, 0.015))
                              await conn.execute("""
                                  INSERT INTO nav_history (fund_id, date, nav)
                                  VALUES ($1, $2, $3)
                                  ON CONFLICT (fund_id, date) DO UPDATE SET nav = $3
                              """, fund['id'], today, round(new_nav, 4))
                              updated += 1
                      except Exception as e:
                          print(f"Error updating fund {fund['id']}: {e}")
                  
                  # Update mutual_funds table with latest NAV
                  await conn.execute("""
                      UPDATE mutual_funds mf
                      SET latest_nav = nh.nav
                      FROM (
                          SELECT DISTINCT ON (fund_id) fund_id, nav
                          FROM nav_history
                          ORDER BY fund_id, date DESC
                      ) nh
                      WHERE mf.id = nh.fund_id
                  """)
                  
                  print(f"âœ… Updated {updated} fund NAVs")
              
              await pool.close()
          
          asyncio.run(main())
          EOF
          python update_navs.py
          
      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Fund NAV Update Failed - ${date}`,
              body: `## âš ï¸ Fund NAV Update Failed!
              
              @Bhidy - **Attention required!**
              
              **Run:** ${context.runId}
              **Date:** ${date}
              
              [View Workflow Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['bug', 'data-collection', 'urgent']
            });

  # =========================================================================
  # JOB 3: DATA HEALTH VERIFICATION
  # =========================================================================
  verify-data-health:
    name: ðŸ¥ Data Health Check
    runs-on: ubuntu-latest
    needs: [update-daily-ohlc, update-fund-navs]
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: pip install asyncpg
        
      - name: Verify Data Integrity
        id: health
        run: python scripts/verify_data_integrity.py
        continue-on-error: true
        
      - name: Generate Health Report
        run: |
          echo "## ðŸ¥ Data Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python scripts/get_data_stats.py >> $GITHUB_STEP_SUMMARY || echo "Stats unavailable"
          
      - name: Create Issue on Critical Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ CRITICAL: Data Health Check Failed - ${date}`,
              body: `## ðŸš¨ CRITICAL: Data Health Check Failed!
              
              @Bhidy - **IMMEDIATE ATTENTION REQUIRED!**
              
              The data integrity check has failed. This means:
              - Some data may be missing
              - Database might have issues
              - Users may see outdated information
              
              **Run:** ${context.runId}
              **Date:** ${date}
              
              [View Workflow Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              **Actions:**
              1. Check the workflow logs
              2. Verify database at https://supabase.com/dashboard
              3. Check live site at https://finhub-pro.vercel.app`,
              labels: ['bug', 'data-health', 'urgent', 'P0']
            });

  # =========================================================================
  # JOB 4: TEST DATABASE CONNECTION
  # =========================================================================
  test-database:
    name: ðŸ”Œ Test Database Connection
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'test_database'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: pip install asyncpg
        
      - name: Test Connection
        run: |
          cat > test_db.py << 'EOF'
          import asyncio
          import asyncpg
          import os
          import ssl
          
          async def main():
              print("ðŸ”Œ Testing database connection...")
              
              db_url = os.environ['DATABASE_URL']
              print(f"URL format: {db_url[:50]}...")
              
              # Create SSL context for Supabase
              ssl_context = ssl.create_default_context()
              ssl_context.check_hostname = False
              ssl_context.verify_mode = ssl.CERT_NONE
              
              try:
                  conn = await asyncpg.connect(db_url, ssl=ssl_context)
                  print("âœ… Connected with SSL context!")
                  
                  # Test query
                  count = await conn.fetchval("SELECT COUNT(*) FROM market_tickers")
                  print(f"âœ… market_tickers has {count} rows")
                  
                  ohlc_count = await conn.fetchval("SELECT COUNT(*) FROM ohlc_history")
                  print(f"âœ… ohlc_history has {ohlc_count} rows")
                  
                  nav_count = await conn.fetchval("SELECT COUNT(*) FROM nav_history")
                  print(f"âœ… nav_history has {nav_count} rows")
                  
                  await conn.close()
                  print("\nâœ… DATABASE CONNECTION SUCCESSFUL!")
                  
              except Exception as e:
                  print(f"âŒ Connection failed: {e}")
                  raise
          
          asyncio.run(main())
          EOF
          python test_db.py
          
      - name: Report Result
        run: |
          echo "## ðŸ”Œ Database Connection Test" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
