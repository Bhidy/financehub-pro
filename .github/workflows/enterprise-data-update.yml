name: Enterprise Data Update System

on:
  schedule:
    # PRICES: Every 5 min during market hours (6-13 UTC = 9-16 Saudi/Cairo)
    - cron: '*/5 6-13 * * 0-4'
    
    # DAILY SYNC: 6 PM Saudi (15:00 UTC)
    - cron: '0 15 * * 0-4'
    
    # EGYPT FUNDS: 7 PM Saudi (16:00 UTC)
    - cron: '0 16 * * 0-4'
    
    # AI INGESTION: 8 PM Saudi (17:00 UTC)
    - cron: '0 17 * * 0-4'
    
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Job to Run'
        required: true
        default: 'prices'
        type: choice
        options:
          - prices
          - daily
          - egypt-funds
          - ingestion
          - backfill

env:
  HF_API_BASE: https://bhidy-financehub-api.hf.space/api/v1/admin

jobs:
  # ============================================================
  # UNIFIED WATCHDOG - Single Job, All Updates via HF Space API
  # ============================================================
  watchdog:
    name: üêï Enterprise Watchdog
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: üöÄ Start Watchdog
        run: echo "Enterprise Watchdog starting at $(date)"

      # ============================================================
      # JOB 1: PRICE REFRESH (Every 5 min during market hours)
      # ============================================================
      - name: üìà Price Refresh
        if: |
          (github.event_name == 'schedule' && contains(github.event.schedule, '*/5')) ||
          (github.event.inputs.job_type == 'prices')
        run: |
          echo "Triggering Price Refresh..."
          for i in 1 2 3; do
            echo "Attempt $i..."
            response=$(curl -s -X POST "${{ env.HF_API_BASE }}/refresh/prices" \
              -H "Content-Type: application/json" --max-time 120)
            echo "Response: $response"
            if [[ $response == *"started"* ]] || [[ $response == *"success"* ]]; then
              echo "‚úÖ Price Refresh Started"
              exit 0
            fi
            echo "‚ö†Ô∏è Retry in 20s..."
            sleep 20
          done
          echo "‚ùå Price Refresh failed after 3 attempts"
          exit 1

      # ============================================================
      # JOB 2: DAILY SYNC (6 PM Saudi - OHLC + Financials)
      # ============================================================
      - name: üìä Daily EOD Sync
        if: |
          (github.event_name == 'schedule' && contains(github.event.schedule, '0 15')) ||
          (github.event.inputs.job_type == 'daily')
        run: |
          echo "Triggering Daily EOD Sync..."
          for i in 1 2 3; do
            echo "Attempt $i..."
            response=$(curl -s -X POST "${{ env.HF_API_BASE }}/refresh/daily" \
              -H "Content-Type: application/json" --max-time 300)
            echo "Response: $response"
            if [[ $response == *"started"* ]] || [[ $response == *"success"* ]]; then
              echo "‚úÖ Daily Sync Started"
              exit 0
            fi
            echo "‚ö†Ô∏è Retry in 20s..."
            sleep 20
          done
          echo "‚ùå Daily Sync failed after 3 attempts"
          exit 1

      # ============================================================
      # JOB 3: EGYPT FUNDS (7 PM Saudi)
      # ============================================================
      - name: üí∞ Egypt Funds Sync
        if: |
          (github.event_name == 'schedule' && contains(github.event.schedule, '0 16')) ||
          (github.event.inputs.job_type == 'egypt-funds')
        run: |
          echo "Triggering Egypt Funds Sync..."
          for i in 1 2 3; do
            echo "Attempt $i..."
            response=$(curl -s -X POST "${{ env.HF_API_BASE }}/refresh/egypt-funds" \
              -H "Content-Type: application/json" --max-time 180)
            echo "Response: $response"
            if [[ $response == *"started"* ]] || [[ $response == *"success"* ]]; then
              echo "‚úÖ Egypt Funds Sync Started"
              exit 0
            fi
            echo "‚ö†Ô∏è Retry in 20s..."
            sleep 20
          done
          echo "‚ùå Egypt Funds Sync failed after 3 attempts"
          exit 1

      # ============================================================
      # JOB 4: AI INGESTION (8 PM Saudi)
      # ============================================================
      - name: ü§ñ AI Knowledge Ingestion
        if: |
          (github.event_name == 'schedule' && contains(github.event.schedule, '0 17')) ||
          (github.event.inputs.job_type == 'ingestion')
        run: |
          echo "Triggering AI Ingestion..."
          for i in 1 2 3; do
            echo "Attempt $i..."
            response=$(curl -s -X POST "${{ env.HF_API_BASE }}/refresh/ingestion" \
              -H "Content-Type: application/json" --max-time 300)
            echo "Response: $response"
            if [[ $response == *"started"* ]] || [[ $response == *"success"* ]]; then
              echo "‚úÖ AI Ingestion Started"
              exit 0
            fi
            echo "‚ö†Ô∏è Retry in 20s..."
            sleep 20
          done
          echo "‚ùå AI Ingestion failed after 3 attempts"
          exit 1

      # ============================================================
      # JOB 5: BACKFILL (Manual Only)
      # ============================================================
      - name: üìö Historical Backfill
        if: github.event.inputs.job_type == 'backfill'
        run: |
          echo "Triggering Historical Backfill..."
          response=$(curl -s -X POST "${{ env.HF_API_BASE }}/refresh/backfill" \
            -H "Content-Type: application/json" --max-time 1800)
          echo "Response: $response"

      # ============================================================
      # ALERTING SYSTEM
      # ============================================================
      - name: ‚úÖ Discord Success Alert
        if: success()
        run: |
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"content": "‚úÖ **FinanceHub Watchdog**: Auto-update cycle completed successfully at '"$(date)"'"}'
          
      - name: üö® Discord Failure Alert
        if: failure()
        run: |
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"content": "üö® **CRITICAL**: FinanceHub Watchdog FAILED! Check: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
