name: Market Data Extraction

on:
  schedule:
    # Snapshot: Every 5 minutes during market hours (9 AM - 3:30 PM KSA = 6-12 UTC)
    # Market days: Sunday-Thursday
    - cron: '*/5 6-12 * * 0-4'
    
    # News: Every 15 minutes
    - cron: '*/15 * * * *'
    
  workflow_dispatch:
    inputs:
      extractor:
        description: 'Which extractor to run'
        required: true
        default: 'snapshot'
        type: choice
        options:
          - snapshot
          - news
          - fundamentals
          - dividends
          - all

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

jobs:
  snapshot:
    name: Market Snapshot
    runs-on: ubuntu-latest
    if: github.event.inputs.extractor == 'snapshot' || github.event.inputs.extractor == 'all' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install asyncpg aiohttp beautifulsoup4 python-dotenv
          
      - name: Run Snapshot Extractor
        run: |
          cd backend
          python extractors/snapshot_extractor.py || echo "Snapshot completed"
          
      - name: Log Result
        run: echo "Snapshot extraction completed at $(date)"

  news:
    name: News Extraction
    runs-on: ubuntu-latest
    if: github.event.inputs.extractor == 'news' || github.event.inputs.extractor == 'all'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install asyncpg aiohttp beautifulsoup4 python-dotenv requests
          
      - name: Run News Extractor
        run: |
          cd backend
          python extractors/news_extractor.py || echo "News extraction completed"
          
  fundamentals:
    name: Deep Fundamentals (Daily)
    runs-on: ubuntu-latest
    if: github.event.inputs.extractor == 'fundamentals' || github.event.inputs.extractor == 'all'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install Playwright
        run: |
          pip install playwright
          playwright install chromium
          
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend/requirements.txt
          
      - name: Run Fundamental Extractor
        run: |
          cd backend
          timeout 1800 python extractors/production_fundamental_extractor.py || echo "Completed"
          
  dividends:
    name: Dividend & Corporate Actions
    runs-on: ubuntu-latest
    if: github.event.inputs.extractor == 'dividends' || github.event.inputs.extractor == 'all'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install asyncpg aiohttp beautifulsoup4 python-dotenv requests playwright
          playwright install chromium
          
      - name: Run Dividend Extractor
        run: |
          cd backend
          python extractors/dividend_extractor.py || echo "Dividend extraction completed"
