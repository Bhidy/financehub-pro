name: Enterprise Data Update System

on:
  schedule:
    # PRICES: Every 5 min during market hours (6-13 UTC = 9-16 Saudi/Cairo)
    - cron: '*/5 6-13 * * 0-4'
    
    # DAILY SYNC: 6 PM Saudi (15:00 UTC)
    - cron: '0 15 * * 0-4'
    
    # EGYPT FUNDS: 7 PM Saudi (16:00 UTC)
    - cron: '0 16 * * 0-4'
    
    # AI INGESTION: 8 PM Saudi (17:00 UTC)
    - cron: '0 17 * * 0-4'
    
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Job to Run'
        required: true
        default: 'prices'
        type: choice
        options:
          - prices
          - daily
          - egypt-funds
          - ingestion
          - backfill

env:
  HF_API_BASE: https://bhidy-financehub-api.hf.space/api/v1/admin

jobs:
  # ============================================================
  # UNIFIED WATCHDOG - Single Job, All Updates via HF Space API
  # ============================================================
  watchdog:
    name: ðŸ• Enterprise Watchdog
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ðŸš€ Start Watchdog
        run: echo "Enterprise Watchdog starting at $(date)"

      # ============================================================
      # JOB 1: PRICE REFRESH (Every 5 min during market hours)
      # ============================================================
      - name: ðŸ“ˆ Price Refresh
        if: |
          (github.event_name == 'schedule' && contains(github.event.schedule, '*/5')) ||
          (github.event.inputs.job_type == 'prices')
        run: |
          echo "Triggering Price Refresh..."
          DELAYS=(10 30 60 120)
          for i in 0 1 2 3; do
            attempt=$((i+1))
            echo "Attempt $attempt/4..."
            response=$(curl -s -X POST "${{ env.HF_API_BASE }}/refresh/prices" \
              -H "Content-Type: application/json" --max-time 300 2>&1 | tee /tmp/refresh_prices.log)
            echo "Response: $response"
            if [[ $response == *"started"* ]] || [[ $response == *"success"* ]] || [[ $response == *"already_running"* ]]; then
              echo "âœ… Price Refresh OK"
              exit 0
            fi
            if [ $i -lt 3 ]; then
              echo "âš ï¸ Retry in ${DELAYS[$i]}s (exponential backoff)..."
              sleep ${DELAYS[$i]}
            fi
          done
          echo "âŒ Price Refresh failed after 4 attempts"
          exit 1

      # ============================================================
      # JOB 2: DAILY SYNC (6 PM Saudi - OHLC + Financials)
      # ============================================================
      - name: ðŸ“Š Daily EOD Sync
        if: |
          (github.event_name == 'schedule' && contains(github.event.schedule, '0 15')) ||
          (github.event.inputs.job_type == 'daily')
        run: |
          echo "Triggering Daily EOD Sync..."
          for i in 1 2 3; do
            echo "Attempt $i..."
            response=$(curl -s -X POST "${{ env.HF_API_BASE }}/refresh/daily" \
              -H "Content-Type: application/json" --max-time 300)
            echo "Response: $response"
            if [[ $response == *"started"* ]] || [[ $response == *"success"* ]] || [[ $response == *"already_running"* ]]; then
              echo "âœ… Daily Sync OK"
              exit 0
            fi
            echo "âš ï¸ Retry in 20s..."
            sleep 20
          done
          echo "âŒ Daily Sync failed after 3 attempts"
          exit 1

      # ============================================================
      # JOB 3: EGYPT FUNDS (7 PM Saudi)
      # ============================================================
      - name: ðŸ’° Egypt Funds Sync
        if: |
          (github.event_name == 'schedule' && contains(github.event.schedule, '0 16')) ||
          (github.event.inputs.job_type == 'egypt-funds')
        run: |
          echo "Triggering Egypt Funds Sync..."
          for i in 1 2 3; do
            echo "Attempt $i..."
            response=$(curl -s -X POST "${{ env.HF_API_BASE }}/refresh/egypt-funds" \
              -H "Content-Type: application/json" --max-time 180)
            echo "Response: $response"
            if [[ $response == *"started"* ]] || [[ $response == *"success"* ]] || [[ $response == *"already_running"* ]]; then
              echo "âœ… Egypt Funds OK"
              exit 0
            fi
            echo "âš ï¸ Retry in 20s..."
            sleep 20
          done
          echo "âŒ Egypt Funds Sync failed after 3 attempts"
          exit 1

      # ============================================================
      # JOB 4: AI INGESTION (8 PM Saudi)
      # ============================================================
      - name: ðŸ¤– AI Knowledge Ingestion
        if: |
          (github.event_name == 'schedule' && contains(github.event.schedule, '0 17')) ||
          (github.event.inputs.job_type == 'ingestion')
        run: |
          echo "Triggering AI Ingestion..."
          for i in 1 2 3; do
            echo "Attempt $i..."
            response=$(curl -s -X POST "${{ env.HF_API_BASE }}/refresh/ingestion" \
              -H "Content-Type: application/json" --max-time 300)
            echo "Response: $response"
            if [[ $response == *"started"* ]] || [[ $response == *"success"* ]] || [[ $response == *"already_running"* ]]; then
              echo "âœ… AI Ingestion OK"
              exit 0
            fi
            echo "âš ï¸ Retry in 20s..."
            sleep 20
          done
          echo "âŒ AI Ingestion failed after 3 attempts"
          exit 1

      # ============================================================
      # JOB 5: BACKFILL (Manual Only)
      # ============================================================
      - name: ðŸ“š Historical Backfill
        if: github.event.inputs.job_type == 'backfill'
        run: |
          echo "Triggering Historical Backfill..."
          response=$(curl -s -X POST "${{ env.HF_API_BASE }}/refresh/backfill" \
            -H "Content-Type: application/json" --max-time 1800)
          echo "Response: $response"

      # ============================================================
      # ALERTING SYSTEM
      # ============================================================
      - name: âœ… Discord Success Alert
        if: success()
        run: |
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"content": "âœ… **FinanceHub Watchdog**: Auto-update cycle completed successfully at '"$(date)"'"}'
          
      - name: ðŸš¨ Discord Failure Alert
        if: failure()
        run: |
          ERROR_LOG=$(cat /tmp/refresh_*.log 2>/dev/null | tail -c 400 || echo "No logs available")
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"content": "ðŸš¨ **CRITICAL**: FinanceHub Watchdog FAILED!\n**Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n**Error:** '"$(echo $ERROR_LOG | tr '"' "'" | head -c 300)"'"}'
