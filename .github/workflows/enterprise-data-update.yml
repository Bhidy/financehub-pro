name: Enterprise Data Update System

on:
  schedule:
    # Daily OHLC & Funds: 6:00 PM UTC (9:00 PM Saudi Time) - after market close
    - cron: '0 18 * * 0-4'
    
    # Intraday News & Actions: Every 4 hours
    - cron: '0 */4 * * 0-4'
    
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ohlc_only
          - funds_only
          - actions_only
          - news_only
          - test_database

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  # =========================================================================
  # JOB 1: DAILY OHLC HISTORY
  # =========================================================================
  update-daily-ohlc:
    name: üìà Daily OHLC Update
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'ohlc_only' || github.event_name == 'schedule'
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: pip install asyncpg yfinance pandas
        
      - name: Update OHLC History
        id: update_ohlc
        run: python scripts/daily_ohlc_update.py
        continue-on-error: true
        
      - name: Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üö® FinanceHub Alert: Daily OHLC Update FAILED"
          to: "${{ secrets.NOTIFICATION_EMAIL }},m.mostafa@mubasher.net"
          from: FinanceHub Pro <${{ secrets.NOTIFICATION_EMAIL }}>
          body: |
            ‚ö†Ô∏è DAILY OHLC UPDATE FAILED
            Run ID: ${{ github.run_id }}
            Link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # =========================================================================
  # JOB 2: MUTUAL FUND NAVs
  # =========================================================================
  update-fund-navs:
    name: üíº Fund NAV Update
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'funds_only' || github.event_name == 'schedule'
    timeout-minutes: 20
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: pip install asyncpg
        
      - name: Update Fund NAVs
        run: python scripts/update_fund_navs.py
        
      - name: Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üö® FinanceHub Alert: Fund NAV Update FAILED"
          to: "${{ secrets.NOTIFICATION_EMAIL }},m.mostafa@mubasher.net"
          from: FinanceHub Pro <${{ secrets.NOTIFICATION_EMAIL }}>
          body: |
            ‚ö†Ô∏è FUND NAV UPDATE FAILED
            Run ID: ${{ github.run_id }}
            Link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # =========================================================================
  # JOB 3: CORPORATE ACTIONS (Dividends)
  # =========================================================================
  update-corporate-actions:
    name: üéÅ Corporate Actions
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'actions_only' || github.event_name == 'schedule'
    timeout-minutes: 20
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: |
          pip install asyncpg playwright
          playwright install chromium
        
      - name: Update Corporate Actions
        run: python scripts/update_corporate_actions.py
        
      - name: Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üö® FinanceHub Alert: Corporate Actions Update FAILED"
          to: "${{ secrets.NOTIFICATION_EMAIL }},m.mostafa@mubasher.net"
          from: FinanceHub Pro <${{ secrets.NOTIFICATION_EMAIL }}>
          body: |
            ‚ö†Ô∏è CORPORATE ACTIONS UPDATE FAILED
            Run ID: ${{ github.run_id }}
            Link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # =========================================================================
  # JOB 4: MARKET NEWS
  # =========================================================================
  update-news:
    name: üì∞ Market News
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'news_only' || github.event_name == 'schedule'
    timeout-minutes: 10
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: pip install asyncpg
        
      - name: Update News
        run: python scripts/update_news.py
        
      - name: Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üö® FinanceHub Alert: News Update FAILED"
          to: "${{ secrets.NOTIFICATION_EMAIL }},m.mostafa@mubasher.net"
          from: FinanceHub Pro <${{ secrets.NOTIFICATION_EMAIL }}>
          body: |
            ‚ö†Ô∏è NEWS UPDATE FAILED
            Run ID: ${{ github.run_id }}
            Link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # =========================================================================
  # JOB 5: DATA HEALTH VERIFICATION
  # =========================================================================
  verify-data-health:
    name: üè• Data Health Check
    runs-on: ubuntu-latest
    needs: [update-daily-ohlc, update-fund-navs, update-corporate-actions, update-news]
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: pip install asyncpg
        
      - name: Verify Data Integrity
        id: health
        run: python scripts/verify_data_integrity.py
        continue-on-error: true
        
      - name: Send Daily Success Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "‚úÖ FinanceHub Daily Update Complete - All Systems Go"
          to: "${{ secrets.NOTIFICATION_EMAIL }},m.mostafa@mubasher.net"
          from: FinanceHub Pro <${{ secrets.NOTIFICATION_EMAIL }}>
          body: |
            ‚úÖ DAILY DATA UPDATE COMPLETED SUCCESSFULLY
            
            Date: ${{ github.run_id }}
            
            All systems verified:
            - OHLC History: Updated
            - Funds: Updated
            - Corporate Actions: Updated
            - Market News: Updated
            
            View your site: https://finhub-pro.vercel.app
            
            ‚Äî FinanceHub Pro Automation
            
      - name: Send Failure Alert Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üö®üö® URGENT: FinanceHub Data Health Check FAILED"
          to: "${{ secrets.NOTIFICATION_EMAIL }},m.mostafa@mubasher.net"
          from: FinanceHub Pro <${{ secrets.NOTIFICATION_EMAIL }}>
          body: |
            üö®üö® CRITICAL: DATA HEALTH CHECK FAILED üö®üö®
            
            Immediate action required!
            Run ID: ${{ github.run_id }}
            Link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
