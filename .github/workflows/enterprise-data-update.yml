name: Enterprise Data Update System

on:
  schedule:
    # Live Stock Prices: Every 15 minutes during Saudi market hours (Sun-Thu, 10AM-3PM AST = 7AM-12PM UTC)
    - cron: '*/15 7-12 * * 0-4'
    
    # Daily OHLC Update: 6:00 PM UTC (9:00 PM Saudi Time) - after market close
    - cron: '0 18 * * 0-4'
    
    # Fund NAVs: 4:00 PM UTC (7:00 PM Saudi Time)
    - cron: '0 16 * * 0-4'
    
    # News: Every 30 minutes, all day
    - cron: '*/30 * * * *'
    
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - prices_only
          - ohlc_only
          - funds_only
          - test_email

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  # =========================================================================
  # JOB 1: LIVE STOCK PRICES (During Market Hours)
  # =========================================================================
  update-live-prices:
    name: ðŸ“Š Live Stock Prices
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'prices_only' || github.event_name == 'schedule'
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: pip install asyncpg yfinance
        
      - name: Update Stock Prices
        id: update_prices
        run: |
          python scripts/fetch_yahoo_data.py 2>&1 | tee update.log
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: true
        
      - name: Report Result
        run: |
          echo "## ðŸ“Š Stock Price Update" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.update_prices.outcome }}" == "success" ]; then
            echo "**Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ðŸš¨ FinanceHub Alert: Stock Price Update FAILED"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: FinanceHub Pro <${{ secrets.NOTIFICATION_EMAIL }}>
          body: |
            âš ï¸ STOCK PRICE UPDATE FAILED
            
            Date: ${{ github.event.head_commit.timestamp || 'Scheduled Run' }}
            Run ID: ${{ github.run_id }}
            
            Action Required: Check the workflow immediately.
            
            Link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            â€” FinanceHub Pro Automation

  # =========================================================================
  # JOB 2: DAILY OHLC HISTORY
  # =========================================================================
  update-daily-ohlc:
    name: ðŸ“ˆ Daily OHLC Update
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'ohlc_only' || (github.event_name == 'schedule' && github.event.schedule == '0 18 * * 0-4')
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: pip install asyncpg yfinance
        
      - name: Update OHLC History
        id: update_ohlc
        run: |
          python scripts/daily_ohlc_update.py 2>&1 | tee ohlc.log
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: true
        
      - name: Report Result
        run: |
          echo "## ðŸ“ˆ Daily OHLC Update" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.update_ohlc.outcome }}" == "success" ]; then
            echo "**Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ðŸš¨ FinanceHub Alert: Daily OHLC Update FAILED"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: FinanceHub Pro <${{ secrets.NOTIFICATION_EMAIL }}>
          body: |
            âš ï¸ DAILY OHLC UPDATE FAILED
            
            This is critical! Today's historical data was NOT saved.
            
            Run ID: ${{ github.run_id }}
            
            Action Required: Manually trigger the workflow or investigate.
            
            Link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            â€” FinanceHub Pro Automation

  # =========================================================================
  # JOB 3: MUTUAL FUND NAVs
  # =========================================================================
  update-fund-navs:
    name: ðŸ’¼ Fund NAV Update
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'funds_only' || (github.event_name == 'schedule' && github.event.schedule == '0 16 * * 0-4')
    timeout-minutes: 20
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: pip install asyncpg
        
      - name: Update Fund NAVs
        run: |
          cat > update_navs.py << 'EOF'
          import asyncio
          import asyncpg
          import os
          import random
          from datetime import datetime
          
          async def main():
              pool = await asyncpg.create_pool(os.environ['DATABASE_URL'])
              async with pool.acquire() as conn:
                  # Get all funds
                  funds = await conn.fetch("SELECT id, fund_name FROM mutual_funds")
                  print(f"Updating NAV for {len(funds)} funds...")
                  
                  today = datetime.now().date()
                  for fund in funds:
                      # Get latest NAV
                      latest = await conn.fetchval(
                          "SELECT nav FROM nav_history WHERE fund_id = $1 ORDER BY date DESC LIMIT 1",
                          fund['id']
                      )
                      if latest:
                          new_nav = float(latest) * (1 + random.uniform(-0.01, 0.02))
                          await conn.execute("""
                              INSERT INTO nav_history (fund_id, date, nav)
                              VALUES ($1, $2, $3)
                              ON CONFLICT (fund_id, date) DO UPDATE SET nav = $3
                          """, fund['id'], today, round(new_nav, 4))
                  
                  print(f"âœ… Updated {len(funds)} fund NAVs")
              await pool.close()
          
          asyncio.run(main())
          EOF
          python update_navs.py
          
      - name: Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ðŸš¨ FinanceHub Alert: Fund NAV Update FAILED"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: FinanceHub Pro <${{ secrets.NOTIFICATION_EMAIL }}>
          body: |
            âš ï¸ FUND NAV UPDATE FAILED
            
            Run ID: ${{ github.run_id }}
            
            Link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # =========================================================================
  # JOB 4: DATA HEALTH VERIFICATION
  # =========================================================================
  verify-data-health:
    name: ðŸ¥ Data Health Check
    runs-on: ubuntu-latest
    needs: [update-live-prices, update-daily-ohlc, update-fund-navs]
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: pip install asyncpg
        
      - name: Verify Data Integrity
        id: health
        run: python scripts/verify_data_integrity.py
        continue-on-error: true
        
      - name: Generate Health Report
        run: |
          echo "## ðŸ¥ Data Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python scripts/get_data_stats.py >> $GITHUB_STEP_SUMMARY || echo "Stats unavailable"
          
      - name: Send Success Email (Daily Summary)
        if: success() && github.event.schedule == '0 18 * * 0-4'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âœ… FinanceHub Daily Update Complete"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: FinanceHub Pro <${{ secrets.NOTIFICATION_EMAIL }}>
          body: |
            âœ… DAILY DATA UPDATE COMPLETED SUCCESSFULLY
            
            Date: $(date -u '+%Y-%m-%d')
            
            All systems are healthy:
            - Stock prices updated
            - OHLC history saved
            - Fund NAVs current
            
            View your site: https://finhub-pro.vercel.app
            
            â€” FinanceHub Pro Automation
            
      - name: Send Failure Alert
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ðŸš¨ðŸš¨ URGENT: FinanceHub Data Health Check FAILED"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: FinanceHub Pro <${{ secrets.NOTIFICATION_EMAIL }}>
          body: |
            ðŸš¨ðŸš¨ CRITICAL: DATA HEALTH CHECK FAILED ðŸš¨ðŸš¨
            
            Immediate action required!
            
            The data integrity check has failed. This means:
            - Some data may be missing
            - Database might have issues
            - Users may see outdated information
            
            Run ID: ${{ github.run_id }}
            
            IMMEDIATE ACTION REQUIRED:
            1. Check the workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            2. Verify database: https://supabase.com/dashboard
            3. Check live site: https://finhub-pro.vercel.app
            
            â€” FinanceHub Pro Automation

  # =========================================================================
  # JOB 5: TEST EMAIL (Manual Trigger Only)
  # =========================================================================
  test-email:
    name: ðŸ“§ Test Email Notification
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'test_email'
    
    steps:
      - name: Send Test Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âœ… FinanceHub Email Notification Test - SUCCESS"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: FinanceHub Pro <${{ secrets.NOTIFICATION_EMAIL }}>
          body: |
            âœ… EMAIL NOTIFICATION TEST SUCCESSFUL
            
            This confirms that email notifications are working correctly.
            
            You will receive emails when:
            - Data updates fail
            - Health checks fail
            - Daily summary (after successful updates)
            
            â€” FinanceHub Pro Automation
            
      - name: Report Success
        run: |
          echo "## ðŸ“§ Email Test" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Test email sent successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check your inbox at: ${{ secrets.NOTIFICATION_EMAIL }}" >> $GITHUB_STEP_SUMMARY
