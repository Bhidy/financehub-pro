name: Data Health Monitor

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  health-check:
    name: Check Data Health
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: pip install asyncpg
      
      - name: Run Health Check
        id: health
        run: |
          python scripts/verify_data_integrity.py
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Generate Health Report
        run: |
          echo "## üè• Data Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python scripts/get_data_stats.py >> $GITHUB_STEP_SUMMARY
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Create Issue & Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const time = new Date().toISOString().split('T')[1].split('.')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® URGENT: Data Health Alert - ${date} ${time} UTC`,
              body: `## ‚ö†Ô∏è Data Integrity Check Failed!
              
              @Bhidy - **Immediate attention required!**
              
              | Detail | Value |
              |--------|-------|
              | **Run ID** | ${context.runId} |
              | **Date** | ${date} |
              | **Time** | ${time} UTC |
              | **Workflow** | Data Health Monitor |
              
              ### üîó Quick Actions
              - [View Workflow Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              - [Check Production API](https://bhidy-financehub-api.hf.space/api/v1/dashboard/data-health)
              - [View Live Site](https://finhub-pro.vercel.app)
              
              ### ‚ö†Ô∏è Possible Causes
              - Data loss or corruption
              - Database connectivity issues
              - Missing scheduled data updates
              - API service down
              
              ### üìß Email Notification
              GitHub will automatically email you about this issue.
              
              **Action Required:** Investigate immediately!`,
              labels: ['bug', 'data-health', 'urgent', 'P0']
            });
