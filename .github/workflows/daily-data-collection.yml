name: Daily Data Collection

on:
  schedule:
    # Run every day at 6:00 PM UTC (9:00 PM Saudi Time - after market close)
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      full_sync:
        description: 'Run full data sync (not just incremental)'
        required: false
        default: 'false'

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  PYTHON_VERSION: '3.11'

jobs:
  collect-market-data:
    name: Collect Market Data
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install asyncpg pandas tls_client aiohttp
      
      - name: Run Daily OHLC Update
        run: |
          python scripts/daily_ohlc_update.py
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Record Collection Stats
        run: |
          echo "## ðŸ“Š Daily Data Collection Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python scripts/get_data_stats.py >> $GITHUB_STEP_SUMMARY
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  verify-data-integrity:
    name: Verify Data Integrity
    runs-on: ubuntu-latest
    needs: collect-market-data
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install asyncpg
      
      - name: Verify Data Counts
        id: verify
        run: |
          python scripts/verify_data_integrity.py
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Send Alert on Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ðŸš¨ FinanceHub Pro - Data Integrity Alert"
          body: |
            Data integrity verification failed!
            
            Please check the GitHub Actions log for details:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.ALERT_EMAIL }}
          from: FinanceHub Pro Alerts
