name: Data Health Monitor

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  health-check:
    name: Check Data Health
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: pip install asyncpg
      
      - name: Run Health Check
        id: health
        run: |
          python scripts/verify_data_integrity.py
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Generate Health Report
        run: |
          echo "## ðŸ¥ Data Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python scripts/get_data_stats.py >> $GITHUB_STEP_SUMMARY
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Data Health Alert - ${date}`,
              body: `## Data Integrity Check Failed!
              
              **Run:** ${context.runId}
              **Date:** ${date}
              
              Please check the [workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.
              
              This could indicate:
              - Data loss or corruption
              - Database connectivity issues
              - Missing scheduled data updates
              
              **Action Required:** Investigate immediately to prevent data loss.`,
              labels: ['bug', 'data-health', 'urgent']
            });
