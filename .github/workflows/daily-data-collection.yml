name: Daily Data Collection

on:
  schedule:
    # Run every day at 6:00 PM UTC (9:00 PM Saudi Time - after market close)
    - cron: '0 18 * * 0-4'  # Sun-Thu only (Saudi trading days)
  workflow_dispatch:  # Allow manual trigger

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  collect-market-data:
    name: Daily Market Data Update
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install asyncpg
      
      - name: Run Daily OHLC Update
        run: python scripts/daily_ohlc_update.py
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Generate Report
        run: |
          echo "## üìä Daily Data Collection Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python scripts/get_data_stats.py >> $GITHUB_STEP_SUMMARY
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  verify-integrity:
    name: Verify Data Integrity
    runs-on: ubuntu-latest
    needs: collect-market-data
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: pip install asyncpg
      
      - name: Verify Data Counts
        run: python scripts/verify_data_integrity.py
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Mark Success
        if: success()
        run: |
          echo "## ‚úÖ Data Integrity Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All data thresholds met. Database is healthy." >> $GITHUB_STEP_SUMMARY
      
      - name: Create Issue & Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Daily Data Collection Failed - ${date}`,
              body: `## ‚ö†Ô∏è Daily Data Collection Failed!
              
              @Bhidy - **Attention required!**
              
              The daily market data update has failed. This means today's data may be missing.
              
              **Run:** ${context.runId}
              **Date:** ${date}
              
              [View Workflow Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              **Action Required:** Re-run the workflow or investigate the failure.`,
              labels: ['bug', 'data-collection', 'urgent']
            });
